// ==============================
// Generator & Datasource
// ==============================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==============================
// ENUMS
// ==============================
enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum OrderStatus {
  PENDING // Order placed, awaiting confirmation
  CONFIRMED // Order confirmed by staff
  PREPARING // Kitchen is preparing
  READY // Order ready for pickup/serving
  COMPLETED // Order delivered to customer
  CANCELLED // Order cancelled
}

enum OrderType {
  DINE_IN
  TAKEAWAY
  DELIVERY
}

enum SauceType {
  MUSTARD
  SOY_SAUCE
  MAYONNAISE
  BARBECUE
  KETCHUP
  HOT_SAUCE
  RANCH
  HONEY_MUSTARD
  SWEET_CHILI
  GARLIC_AIOLI
  OTHER

  @@map("sauce_types")
}

// Cheese types enum
enum CheeseType {
  CHEDDAR
  MOZZARELLA
  PARMESAN
  BLUE_CHEESE
  GOAT_CHEESE
  SWISS
  FETA
  CREAM_CHEESE
  PROVOLONE
  OTHER

  @@map("cheese_types")
}

// ==============================
// MODELS
// ==============================

model Restaurant {
  id          String     @id @default(cuid())
  slug        String     @unique
  name        String
  phone       String?
  logo        String?
  heroImage   String?
  tagline     String?    @default("")
  story       String?
  description String?
  menuBaseUrl String?
  schedules   Schedule[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categories Category[]
  menuItems  MenuItem[]
  orders     Order[]

  @@index([slug])
  @@index([isActive])
  @@map("restaurants")
}

model Schedule {
  id           String @id @default(cuid())
  restaurantId String

  dayOfWeek DayOfWeek
  opensAt   String // "08:00"
  closesAt  String // "23:00"
  isClosed  Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, dayOfWeek])
  @@index([restaurantId])
  @@map("schedules")
}

model Category {
  id           String @id @default(cuid())
  restaurantId String

  nameEn String?
  nameFr String?
  nameAr String?
  icon   String?

  visible Boolean @default(true)
  order   Int     @default(0)

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItems  MenuItem[]

  @@unique([restaurantId, nameEn])
  @@unique([restaurantId, nameFr])
  @@unique([restaurantId, nameAr])
  @@index([restaurantId, visible, isActive])
  @@index([restaurantId, order])
  @@map("categories")
}

model MenuItem {
  id           String @id @default(cuid())
  restaurantId String
  categoryId   String

  nameEn String?
  nameFr String?
  nameAr String?

  descriptionEn String?
  descriptionFr String?
  descriptionAr String?

  price     Decimal @db.Decimal(10, 2)
  image     String?
  available Boolean @default(true)

  isActive             Boolean @default(true)
  isChefRecommendation Boolean @default(false)
  isPopular            Boolean @default(false)
  isSpicy              Boolean @default(false)
  isVegetarian         Boolean @default(false)

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  restaurant  Restaurant           @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category    Category             @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[]          @relation // ← Order items are optional (can be empty array)
  // New relations for sauces and cheese
  sauces      MenuItemSauce[]
  cheeses     MenuItemCheese[]
  supplements MenuItemSupplement[]

  @@index([restaurantId, categoryId, available, isActive])
  @@index([categoryId])
  @@map("menu_items")
}

model MenuItemSupplement {
  id          String  @id @default(cuid())
  menuItemId  String
  name        String
  category    String // e.g., "Viandes", "Fromages", "Légumes"
  price       Decimal @db.Decimal(10, 2)
  isAvailable Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  menuItem MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@index([menuItemId])
  @@map("menu_item_supplements")
}

// Junction table for menu item sauces
model MenuItemSauce {
  id         String    @id @default(cuid())
  menuItemId String
  sauceType  SauceType
  customName String? // For when sauceType is OTHER
  isIncluded Boolean   @default(false) // Is it included by default?
  extraCost  Decimal?  @db.Decimal(10, 2) // Additional cost if any

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  menuItem MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, sauceType, customName])
  @@index([menuItemId])
  @@map("menu_item_sauces")
}

// Junction table for menu item cheeses
model MenuItemCheese {
  id         String     @id @default(cuid())
  menuItemId String
  cheeseType CheeseType
  customName String? // For when cheeseType is OTHER
  isIncluded Boolean    @default(false) // Is it included by default?
  extraCost  Decimal?   @db.Decimal(10, 2) // Additional cost if any

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  menuItem MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, cheeseType, customName])
  @@index([menuItemId])
  @@map("menu_item_cheeses")
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Customer {
  id        String  @id @default(cuid())
  phone     String  @unique
  firstName String?
  lastName  String?
  email     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]

  @@index([phone])
  @@map("customers")
}

model Order {
  id           String  @id @default(cuid())
  orderNumber  String? @unique
  restaurantId String
  customerId   String? // Optional: for walk-in customers without registration

  // Customer info (for walk-ins without customer record)
  customerName    String?
  customerPhone   String?
  customerAddress String?
  // Order Details
  type            OrderType
  status          OrderStatus @default(PENDING)
  tableNumber     String? // For dine-in orders

  // Pricing
  subtotal Decimal @db.Decimal(10, 2)
  tax      Decimal @default(0) @db.Decimal(10, 2)
  discount Decimal @default(0) @db.Decimal(10, 2)
  total    Decimal @db.Decimal(10, 2)

  // Payment (always cash, paid at restaurant)
  isPaid Boolean   @default(false)
  paidAt DateTime?

  // Additional Info
  notes      String? // Customer notes/special requests
  adminNotes String? // Internal staff notes

  // Timing
  confirmedAt DateTime?
  completedAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  restaurant    Restaurant           @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  customer      Customer?            @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items         OrderItem[]
  statusHistory OrderStatusHistory[]

  @@index([restaurantId, status, createdAt])
  @@index([customerId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@index([tableNumber])
  @@map("orders")
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  menuItemId String?

  // Snapshot of item at time of order
  name     String
  price    Decimal @db.Decimal(10, 2)
  quantity Int

  // Customization
  notes           String? // Special instructions (e.g., "no onions", "extra spicy")
  selectedSauces  Json? // Array of selected sauce types and custom names
  selectedCheeses Json? // Array of selected cheese types and custom names

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order    Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem? @relation(fields: [menuItemId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([menuItemId])
  @@map("order_items")
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String
  status    OrderStatus
  notes     String?
  changedBy String? // Staff member name or user ID

  createdAt DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
  @@map("order_status_history")
}
